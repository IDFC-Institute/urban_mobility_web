<!DOCTYPE html>
<html>
<head>
<title>Mumbai: Costs of Commuting</title>
<meta charset="utf-8" />
<!-- https://www.d3-graph-gallery.com/graph/backgroundmap_leaflet_buttonLayer.html -->
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
<!-- <script src="http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.js"></script> -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>

<style>
  @import url(https://d19vzq90twjlae.cloudfront.net/leaflet-0.6.1/leaflet.css);
  /* old url http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.css); */

  /* #map{ THIS SEEMS CLEANER BUT NOT SURE WHY NOT WORKING; NOT WORTH WORKING OUT RIGHT NOW
    float:left;
    display:flex;
    flex:75%;
    background:#000000;
    height:100vh;
  }

  .navigation{
    float:right;
    background:red;
    width:25vh;
    height:90vh;
  }

  .row{
    display: flex;
  }

  .column{
    flex: 50%;
    padding: 10px;
  }

  h1{
    color:#ea5153;
    font-size:3rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 5px;
    text-align: center;
  }

  h2{
    font-size:2rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 5px;
    color:#ea5153;
    text-align: center;
  }

  h3{
    font-size:1.8rem;
    color:#FFFFFF;
    font-family: Futura, Arial, "sans-serif";
    margin: 0 auto;
    padding: 10px;
    text-align: center;
  }

  p{
    color:#FFFFFF;
    font-size:0.8rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
    width: 50%;
    text-align: center;
  } */


  .navigation {
      float:right;
      background:red;
      width:25vh;
      height:90vh;
    }
  #map{
    /* float:left; */
     display:flex;
     flex:100%;
     background:white;
     height:100vh;
    }
  .row{
    display:flex;
  }
  .column{
    flex:50%;
    text-align:center;
  }
  h1{
    color:#ea5153;
    font-size:3rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
  }
  h2{
    font-size:2rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
    color:#ea5153;
  }
  h3{
    font-size:1.8rem;
    color:#FFFFFF;
    font-family: Futura, Arial, "sans-serif";
    margin: 0 auto;
    padding: 10px;
  }
  h4{
    color:#FFFFFF;
    font-size:1rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
    width: 50%;
  }

</style>
</head>

<body style="background-color:#000000">

<!-- <div class="row"> THIS SEEMS CLEANER BUT NOT SURE WHY NOT WORKING; NOT WORTH WORKING OUT RIGHT NOW
  <div class="column">
      <div id="map"></div>
  </div>
  <div class="column">

      <h1>Mumbai:<br>Costs of Commuting</h1>
      <p>Ease of mobility is crucial for cities’ productivity. Better mobility allows better access to jobs and allows firms access to a larger pool of workers. As cities grow, congestion can rapidly erode productivity as well as impose heavy environmental costs. We used publicly-available Uber Movement data to measure congestion in the three years up to and including 2018.</p>
      <h3>Select your home and work.</h3>

      <div class="row">
        <div class="column">
        <h2 id="TextDistance"></h2>
        <h3>Distance</h3>
      </div>

      <div class="column">
        <h2 id="TextOC"></h2>
        <h3>Opportunity Cost</h3>
        </div>
      </div>

      <div class="row">
        <div class="column">
        <h2 id="TextFuelCost"></h2>
        <h3>Fuel Cost</h3>
      </div>

      <div class="column">
        <h2 id="TextEnvCost"></h2>
        <h3>CO₂ Cost</h3>
        </div>
      </div>

  </div>
</div> -->

<div class="row">
  <div id="map"></div>
    <div id="navigation" style="text-align:center">
     <h1>Mumbai:<br>Costs of Commuting</h1>
      <CENTER><h4>Ease of mobility is crucial for cities’ productivity. Better mobility allows better access to jobs and allows firms access to a larger pool of workers. As cities grow, congestion can rapidly erode productivity as well as impose heavy environmental costs. We used publicly-available Uber Movement data to measure congestion in the three years up to and including 2018.</h4></CENTER>
     <h3>Select your home and work.</h3>

      <div class="row">
        <div class="column">
         <h2 id="TextDistance"></h2>
         <h3>Distance</h3>
       </div>
       <div class="column">
         <h2 id="TextOC"></h2>
         <h3>Opportunity Cost</h3>
       </div>
      </div>

      <div class="row">
        <div class="column">
          <h2 id="TextFuelCost"></h2>
          <h3>Economic Cost</h3>
        </div>
        <div class="column">
         <h2 id="TextEnvCost"></h2>
         <h3>Environmental Cost</h3>
        </div>
      </div>
      
    </div>
  </div>
</div>

        <!-- <div class="row">
          <div class="b">
            <h3 style="text-align:center">Definitions</h3>
            <h4 style="padding-left:1rem">Distance: Total distance (km).<br>
            Opportunity Cost: Cost of spending additional time commuting, which could have been used for work or leisure (INR). <br>Assumes equal probability of work and leisure and takes as inputs additional commuting hours and a user-supplied monthly wage using this page's slider.<br>
            Total Economic Cost: Opportunity cost plus additional fuel cost for the selected route (INR).<br>
            Total Environmental Cost: Total cost of additional CO<sub>2</sub> emissions for the selected route (INR).<br>
            Note: Generalised exchange rate of USD 1 to INR 70.
            </h4>
          </div>
        </div> -->

<script> //sets initial variables
var hourly_wage = 50; // THIS NEEDS CHANGING IF WE DECIDE TO CHANGE THE HOURLY WAGE
var wage = hourly_wage*7*9*4; //Users should be able to input their monthly wage, which we divide to find hourly wage
var dist;
var oc;
var econ;
var env;
var active;
var zoomlevel = 12; //set initial zoom level of map

//sets blank values initially
d3.select("#TextDistance").text(" - km");
d3.select("#TextOC").text("- INR");
d3.select("#TextFuelCost").text("- INR");
d3.select("#TextEnvCost").text("- INR");

//makes routing variable
var route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: [],
    router: new L.Routing.OSRMv1({
       serviceUrl: 'http://15.206.6.188:5000/route/v1'
     })
  });

//routing function to draw route
function DrawARoute(OriginLat, OriginLon, DestLat, DestLon)
{
  map.removeControl(route);

  //https://www.liedman.net/leaflet-routing-machine/tutorials/basic-usage/
  route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: [
      L.latLng(OriginLat, OriginLon),
      L.latLng(DestLat, DestLon)
    ],

     router: new L.Routing.OSRMv1({
        serviceUrl: 'http://15.206.6.188:5000/route/v1'
      }),
    fitSelectedRoutes: false,
    lineOptions: { styles: [{color: 'black', opacity: 1, weight: 5}]},
    routeWhileDragging: true,
    geometryOnly: true,
    show: false,
    addWaypoints: false
  }).addTo(map);
}

//initialize map and set center point
var map = L.map('map', { zoomControl: true }).setView([19.0760,72.8777], zoomlevel);
//map.scrollWheelZoom.disable();
//map.dragging.disable();

//initialize tiles for map
var tiles_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Map: &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>', minZoom: zoomlevel, maxZoom: 18}).addTo(map);
L.control.layers(tiles_osm).addTo(map);

</script>

<script> //initialize items for D3 selections
var a = 0;
var click = a + 1;
var o_id;
var d_id;
var origin_lat;
var origin_lon;
var dest_lat;
var dest_lon;

//make SVG and G elements
//https://gist.github.com/d3noob/9211665
var svg = d3.select(map.getPanes().overlayPane).append("svg"),
  g = svg.append("g").attr("class", "leaflet-zoom-hide");

g.attr('pointer-events','all');

//import and display TAZ tiles
d3.json("joined_centroidshexclusters.geojson", function(geoShape) {
//code from http://bl.ocks.org/phil-pedruco/7381401

  let clickEnabled = false;

  //  create a d3.geo.path to convert GeoJSON to SVG
  var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);

  // create path elements for each of the features
  d3_features = g.selectAll("path")
    .data(geoShape.features)
    .enter()
    .append("path");

    map.on("viewreset", reset);
    reset();

  //assign features to mouseover, mouseout, onclick
  d3_features.on("mouseover", mouseOver)
  .on("mouseout", mouseOut)
  .on("click", onClick)

  //use Leaflet to implement a D3 geometric transformation
  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

  //fit the SVG element to leaflet's map layer
  function reset() {
    bounds = path.bounds(geoShape);
    var topLeft = bounds[0],
      bottomRight = bounds[1];
    svg .attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px");
    g .attr("transform", "translate(" + -topLeft[0] + ","
                                     + -topLeft[1] + ")");
    // initialize the path data
    d3_features.attr("d",path)
    .style("fill-opacity",0)
    .attr("fill","#ea5153");
  }

  //mouseover function
  function mouseOver(d) {
      d3.select(this)
      .transition()
      .style("stroke","#ea5153")
      .style("fill-opacity",1);
    }

  //mouseout function
  function mouseOut(d){
      d3.select(this)
      .transition()
      .style("fill-opacity",0)
      .style("stroke-opacity",0);
    }

  //keep track of the highlighted polygon and reassign colours based on new clicks
  var highlightedRect = d3.select(null);

  //onclick function
  function onClick(d){
    d3.select(this)
    .style("fill-opacity",0.5)
    .style("fill","#ea5153")
    .style("stroke-width",5)
    .style("stroke","black");

    console.log("click number");
    console.log(click);
    console.log("a");
    console.log(a);
    if(click % 3 == 0){ //reset all colours of TAZs
      console.log("i'm divisible by 3");
      //reset colours
    }

    if(a % 2 == 0) { //if first click on the map
      origin_lat = d.properties.mumbai_centroids_Lat;
      origin_lon = d.properties.mumbai_centroids_Lon;

      if(a == 0){ //if first click on the map
        o_id = d.properties.MOVEMENT_ID; //get the o_id
        // highlightedRect = d3.select(this)
        // .style("fill-opacity",1)
        // .style("fill","white");
      }
      else if(a != 0){ //if odd clicks on map (not 1st click)
        o_id = d_id;
        d_id = d.properties.MOVEMENT_ID;
        // highlightedRect = d3.select(this)
        // .style("fill-opacity",1)
        // .style("fill","red");
      }
    }

      else if(a % 2 != 0){ //if second click on the map
        dest_lat = d.properties.mumbai_centroids_Lat;
        dest_lon = d.properties.mumbai_centroids_Lon;

        if(d_id == null){
          d_id = d.properties.MOVEMENT_ID;
          // highlightedRect = d3.select(this)
          // .style("fill-opacity",1)
          // .style("fill","white");

        }
        else{ //if even click on map
          o_id = d_id;
          d_id = d.properties.MOVEMENT_ID;
          // highlightedRect = d3.select(this)
          // .style("fill-opacity",1)
          // .style("fill","blue");
        }
      }

    a = a + 1; //advance the counter
    click = click + 1; //advance the click

    //make a unique O-D pair variable to filter the CSV data
    o_d_pair = o_id.concat("-",d_id)
    console.log(o_d_pair);

    //call DrawARoute function between Origin and Destination TAZs
    DrawARoute(origin_lat,origin_lon, dest_lat, dest_lon);

    //read the CSV and get all the values needed for the user
      d3.csv("mumbai_all_tazs.csv", function(data){
        for(var i = 0; i < data.length; i++){
          if(data[i].unique_id == o_d_pair){
            console.log("calculating for TAZs: ");
            console.log(data[i].unique_id);
            //Opportunity cost of congestion = Additional hours in commute *
            //((probability of working * wage cost) + (probability of leisure * (wage cost/2)))
            //9 hour workday, 7 day workweek. what's weekly equation, then convert to hourly
            // wage = 12600;

            dist = data[i].distance;
            oc = data[i].additional_hours_commuting*((0.5*(wage/9/7/4))+(0.5*(wage/9/7/4)));
            econ = data[i].add_petrol_costs;
            env = data[i].total_petrol_emissions;

            d3.select("#TextDistance").text(dist + " km");
            d3.select("#TextOC").text(Math.round(oc) +" INR");
            d3.select("#TextFuelCost").text(Math.round(econ) + " INR");
            d3.select("#TextEnvCost").text(Math.round(env) + " INR");

          }
        }
      }) //end CSV
    reset();
  }// end onClick
}); //end geoJSON


  //https://www.d3-graph-gallery.com/graph/bubblemap_leaflet_basic.html
  function update()
  {
    d3.selectAll("polygon")
    .attr("cx", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).x })
    .attr("cy", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).y });
  }

  map.on("moveend", update)

</script>

</body>
</html>
