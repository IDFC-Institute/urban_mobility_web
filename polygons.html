<!DOCTYPE html>
<html>
<head>
<title>Mumbai: Costs of Commuting</title>
<meta charset="utf-8" />
<!-- https://www.d3-graph-gallery.com/graph/backgroundmap_leaflet_buttonLayer.html -->
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
<!-- <script src="http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.js"></script> -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>

<style>
  @import url(https://d19vzq90twjlae.cloudfront.net/leaflet-0.6.1/leaflet.css);
  /* old url http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.css); */


  #navigation {

      width:100vh;
      height:90vh;
    }
  #map{
     display:flex;
     flex:100%;
     background:white;
     height:100vh;
     width:50vh;
    }
  .row{
    display:flex;
  }
  .column{
    flex:50%;
    text-align:center;
  }
  h1{
    color:#ea5153;
    font-size:2rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
  }
  h2{
    font-size:1rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
    color:#ea5153;
  }
  h3{
    font-size:0.7rem;
    color:#FFFFFF;
    font-family: Futura, Arial, "sans-serif";
    margin: 0 auto;
    padding: 10px;
  }
  h4{
    color:#FFFFFF;
    font-size:0.7rem;
    font-family: Futura, Arial, "sans-serif";
    padding: 10px;
    width: 80%;
  }

  .stroke {
    fill: none;
    stroke: #000;
    stroke-width: 1px;
  }

  .fill {
    fill: #f2f2f2;
  }

  label{
  color:#f2f2f2;
  font-family: Futura, Arial, "sans-serif";
  }

</style>
</head>

<body style="background-color:#000000">

<div class="row">
  <div id="map"></div>
    <div id="navigation" style="text-align:center">
      <h1>Mumbai:<br>Costs of Commuting</h1>
      <CENTER><h4>Ease of mobility is crucial for citiesâ€™ productivity. Better mobility allows better access to jobs and allows firms access to a larger pool of workers. As cities grow, congestion can rapidly erode productivity as well as impose heavy environmental costs. We used publicly-available Uber Movement data to measure congestion in the three years up to and including 2018. (We assume here a 50 INR/hour wage and that 70 INR = 1 USD.)</h4>
        <h4>Step 1: Input your monthly wage using the slider.</h4><CENTER>
        <div>
          <p>
              <!-- <label><h3>Your Monthly Wage:</h3></label> -->
              <input type="range" id="toPrice" value="12600" min="12600" max="500000"
                  oninput="document.getElementById('tPrice').innerHTML = this.value" />
              <br></br>
              <label id="tPrice"></label>
          </p>
          <p><input type="submit" value="Save Wage" onclick="ti()" /></p>
        </div>

        <CENTER><h4>Step 2: Select your <span style="color:green">home</span> and <span style="color:red">work</span>. Tap anywhere on the map a third time to clear it.</h4></CENTER>
      <div class="row">
        <div class="column">
         <h2 id="TextDistance"></h2>
         <h3>Distance</h3>
       </div>
       <div class="column">
         <h2 id="TextOC"></h2>
         <h3>Opportunity Cost</h3>
       </div>
      </div>

      <div class="row">
        <div class="column">
          <h2 id="TextFuelCost"></h2>
          <h3>Fuel Cost</h3>
        </div>
        <div class="column">
         <h2 id="TextEnvCost"></h2>
         <h3>Environmental Cost</h3>
        </div>
      </div>


      <!-- <div class="row">
        <div class="column">
          <div class="range-slider" data-slider data-options="display_selector: #days-off-count; initial: 28;">
            <span class="range-slider-handle" role="slider" tabindex="0"></span>
            <span class="range-slider-active-segment"></span>
          </div>
        </div>
        <div class="column">
          <input type="number" id="days-off-count" value="28" />
        </div>
      </div> -->

      <!-- <div class="row">
      <button><a type=button class="text_input form-control" value="Segment_Value" onClick="clearMap();" class="segment_button">Clear Map</a>
      </div> -->

    </div>
  </div>
</div>

<script> //sets initial variables
var hourlyWage;
var monthlyWage;

//check for current wage slider
function ti() { //when the user drags and stops the slider...
    monthlyWage = document.getElementById('tPrice').innerHTML; //get the slider value
    console.log(monthlyWage); //print value
}

var dist;
var oc;
var econ;
var env;
var active;
var zoomlevel = 11; //set initial zoom level of map

var colors = { clickable: 'black', origin: 'green', dest: "red", clickhover: "lightgreen", none:"white" };

function clearMap(){
  d3.selectAll("path").remove();
  //sets blank values initially
  d3.select("#TextDistance").text(" - km");
  d3.select("#TextOC").text("- INR");
  d3.select("#TextFuelCost").text("- INR");
  d3.select("#TextEnvCost").text("- INR");
  console.log("map cleared");
  showJSON();
}
//sets blank values initially
d3.select("#TextDistance").text(" - km");
d3.select("#TextOC").text("- INR");
d3.select("#TextFuelCost").text("- INR");
d3.select("#TextEnvCost").text("- INR");

//makes routing variable
var route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: [],
    router: new L.Routing.OSRMv1({
       serviceUrl: 'http://15.206.6.188:5000/route/v1'
     })
  });

//routing function to draw route
function DrawARoute(OriginLat, OriginLon, DestLat, DestLon)
{
  map.removeControl(route);

  //https://www.liedman.net/leaflet-routing-machine/tutorials/basic-usage/
  route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: [
      L.latLng(OriginLat, OriginLon),
      L.latLng(DestLat, DestLon)
    ],

     router: new L.Routing.OSRMv1({
        serviceUrl: 'http://15.206.6.188:5000/route/v1'
      }),
    fitSelectedRoutes: false,
    lineOptions: { styles: [{color: 'black', opacity: 1, weight: 5}]},
    routeWhileDragging: true,
    geometryOnly: true,
    show: false,
    addWaypoints: false
  }).addTo(map);
}

//initialize map and set center point
var map = L.map('map', { zoomControl: true }).setView([19.0760,72.8777], zoomlevel);
//map.scrollWheelZoom.disable();
//map.dragging.disable();

//initialize tiles for map
var tiles_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Map: &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>', minZoom: zoomlevel, maxZoom: 18}).addTo(map);
L.control.layers(tiles_osm).addTo(map);

</script>

<script>
function showJSON(){//initialize items for D3 selections
var a = 0;
var click = a + 1;
var o_id;
var d_id;
var origin_lat;
var origin_lon;
var dest_lat;
var dest_lon;

//make SVG and G elements
//https://gist.github.com/d3noob/9211665
var svg = d3.select(map.getPanes().overlayPane).append("svg"),
  g = svg.append("g")
  .attr("class", "leaflet-zoom-hide");

g.attr('pointer-events','all');

  //import and display TAZ tiles
  d3.json("joined_centroidshexclusters.geojson", function(geoShape) {
  //code from http://bl.ocks.org/phil-pedruco/7381401

    let clickEnabled = false;

    //  create a d3.geo.path to convert GeoJSON to SVG
    var transform = d3.geo.transform({point: projectPoint}),
              path = d3.geo.path().projection(transform);

    // create path elements for each of the features
    d3_features = g.selectAll("path")
      .data(geoShape.features)
      .enter()
      .append("path")
      .classed("clicked",false)
      .classed("origin",false)
      .classed("dest",false)
      .classed("non-od",true)
      .style("stroke-opacity",1)
      .style("stroke-width",3)
      .style("fill-opacity",0);

      map.on("viewreset", reset);
      reset();

    //assign features to mouseover, mouseout, onclick
    d3_features.on("mouseover", mouseOver)
    .on("mouseout", mouseOut)
    .on("click", onClick)

    //use Leaflet to implement a D3 geometric transformation
    function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }

    //fit the SVG element to leaflet's map layer
    function reset() {
      bounds = path.bounds(geoShape);
      var topLeft = bounds[0],
        bottomRight = bounds[1];
      svg .attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");
      g .attr("transform", "translate(" + -topLeft[0] + ","
                                       + -topLeft[1] + ")");
      // initialize the path data
      d3_features.attr("d",path);
    }


    //mouseover function
    function mouseOver(d) {
      c = d3.select(this);
      // if(c.classed("clicked")){
      //   c.attr("stroke",colors.hover);
      //   c.attr("fill",colors.clicked);
      // }
      // else{
      //   c.attr("stroke",colors.hover);
      // }
      }

    //mouseout function
    function mouseOut(d){
      // c = d3.select(this);
      // if(c.classed("clicked")){
      //   c.attr("stroke-opacity",1)
      //   c.attr("fill",colors.clicked);
      // }
      // c.attr("stroke-opacity",0);
      }

    //onclick function
    function onClick(d){

      console.log("click number");
      console.log(click);
      console.log("a");
      console.log(a);
      if(click == 3){
        clearMap();
      }

      if(click % 3 == 0){
         console.log("i'm divisible by 3");
       }

      if(a % 2 == 0) { //if click not divisible by 2 (1, 3, 5, 7)
        origin_lat = d.properties.mumbai_centroids_Lat;
        origin_lon = d.properties.mumbai_centroids_Lon;

              if(a == 0){ //if click 1
                o_id = d.properties.MOVEMENT_ID; //get the o_id
                //origin = true
                d3.select(this)
                .classed("clicked",true)
                .classed("origin",true)
                .classed("non-od",false)
                .attr("stroke",colors.origin);
              }

              else if(a != 0){ //if click 3, 5, 7
                o_id = d_id;
                d_id = d.properties.MOVEMENT_ID;

                var all_clicked = d3.selectAll(".clicked");

                //selection inspiration from https://bl.ocks.org/austinczarnecki/fe80afa64724c9630930
                //make new origin
                if(all_clicked.classed("dest")){ //make all points where dest=true --> becomes new origin
                  all_clicked.classed("clicked",true);
                  all_clicked.classed("non-od",false);
                  all_clicked.classed("origin",true);
                  all_clicked.classed("dest",false);
                  all_clicked.attr("stroke",colors.origin); //origin = blue
                }

                //make new destination
                d3.select(this)
                .classed("clicked",true)
                .classed("non-od",false)
                .classed("origin",false)
                .classed("dest",true)
                .attr("stroke",colors.dest); //destination = red
                }
        }

        else if(a % 2 != 0){ //if click not divisible by 2
          dest_lat = d.properties.mumbai_centroids_Lat;
          dest_lon = d.properties.mumbai_centroids_Lon;

          if(d_id == null){ //if click 2
            d_id = d.properties.MOVEMENT_ID;
            d3.select(this)
            .classed("clicked",true)
            .classed("non-od",false)
            .classed("dest",true)
            .attr("stroke",colors.dest);
          }
          else{ //if click 4, 6, 8
            o_id = d_id;
            d_id = d.properties.MOVEMENT_ID;

            var all_clicked = d3.selectAll(".clicked");

            //make new origin
            if(all_clicked.classed("dest")){ //make all points where dest=true --> becomes new origin
              all_clicked.classed("clicked",true);
              all_clicked.classed("non-od",false);
              all_clicked.classed("origin",true);
              all_clicked.classed("dest",false);
              all_clicked.attr("stroke",colors.origin); //origin = blue
            }

            d3.select(this)
            .classed("clicked",true)
            .classed("non-od",false)
            .classed("dest",true)
            .attr("stroke",colors.dest);
            }
          }

      a = a + 1; //advance the counter
      click = click + 1; //advance the click

      //make a unique O-D pair variable to filter the CSV data
      o_d_pair = o_id.concat("-",d_id)
      console.log(o_d_pair);

      //call DrawARoute function between Origin and Destination TAZs
      DrawARoute(origin_lat,origin_lon, dest_lat, dest_lon);

      function updateValues(){
      //read the CSV and get all the values needed for the user
        d3.csv("mumbai_all_tazs.csv", function(data){
          for(var i = 0; i < data.length; i++){
            if(data[i].unique_id == o_d_pair){
              console.log("calculating for TAZs: ");
              console.log(data[i].unique_id);
              //Opportunity cost of congestion = Additional hours in commute *
              //((probability of working * wage cost) + (probability of leisure * (wage cost/2)))
              //9 hour workday, 7 day workweek. what's weekly equation, then convert to hourly

              if(monthlyWage != null){
                console.log("found monthly wage");
                hourlyWage = monthlyWage/7/9/4;
                console.log("hourly wage is now");
                console.log(hourlyWage);
              }
              else{
                console.log("no monthly wage");
                hourlyWage = 50;
              }

              dist = data[i].distance;
              oc = data[i].additional_hours_commuting*((0.5*(hourlyWage))+(0.5*(hourlyWage)));
              econ = data[i].add_petrol_costs;
              env = data[i].total_petrol_emissions;

              d3.select("#TextDistance").text(dist + " km");
              d3.select("#TextOC").text(Math.round(oc) +" INR");
              d3.select("#TextFuelCost").text(Math.round(econ) + " INR");
              d3.select("#TextEnvCost").text(Math.round(env) + " INR");

            }
          }
        }) //end CSV
        }
      updateValues();
      reset();
    }// end onClick
  }); //end geoJSON

}//end function

showJSON();

  //https://www.d3-graph-gallery.com/graph/bubblemap_leaflet_basic.html
  function update()
  {
    clearMap();
    d3.selectAll("polygon")
    .attr("cx", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).x })
    .attr("cy", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).y });
  }

  map.on("moveend", update)

</script>

</body>
</html>
