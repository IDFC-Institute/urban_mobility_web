<!DOCTYPE html>
<html>
<head>
  <title>Mumbai: Costs of Commuting</title>
  <meta charset="utf-8" />
  <!-- https://www.d3-graph-gallery.com/graph/backgroundmap_leaflet_buttonLayer.html -->
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

  <!-- <script src="http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.js"></script> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>

  <style>
  @import url(https://d19vzq90twjlae.cloudfront.net/leaflet-0.6.1/leaflet.css);
    /* old url http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.css); */
  .navigation {
    float:right;
    background:red;
    width:25vh;
    height:90vh;
  }

  #map{
    float:left;
     display:flex;
     flex:75%;
     background:white;
     height:100vh;
    }

    .container{
      width:100%;
      height:100%;
    }

    .row{
      display:flex;
    }

    .column{
      flex:50%;
      text-align:center;
    }

h1{
  color:#ea5153;
  font-size:3rem;
  font-family: Futura, Arial, "sans-serif";
  padding: 10px;
}

h2{
  font-size:2rem;
  font-family: Futura, Arial, "sans-serif";
  padding: 10px;
  color:#ea5153;
}

h3{
  font-size:1.8rem;
  color:#FFFFFF;
  font-family: Futura, Arial, "sans-serif";
  margin: 0 auto;
  padding: 10px;
}

  .info h1 {
      margin: 0 0 10px;
      color: ##FFFFFF;
      font-family: Futura, Arial, "sans-serif";
  }

  .legend {
    width:200px;
    height:100px;
    line-height: 18px;
    color: #555;
    font-family: Futura, Arial, "sans-serif";
  }

  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
    font-family: Futura, Arial, "sans-serif";
  }

  div.b {
  line-height: 1.6;
  text-align:left;
  font-family: Futura, Arial, "sans-serif";
}
.slidecontainer {
  width: 100%; /* Width of the outside container */
}


.rangeslider{
  width: 75%;
  font-family: Futura, Arial, "sans-serif";
  color:#ea5153;
  font-size:1.5rem;
}

.myslider {
  -webkit-appearance: none;
  background: #FCF3CF ;
  width: 50%;
  height: 20px;
  opacity: 2;
}


.myslider::-webkit-slider-thumb {
  -webkit-appearance: none;
  cursor: pointer;
  background: #34495E ;
  width: 5%;
  height: 20px;
}


.myslider:hover {
  opacity: 1;
}


  </style>
</head>

<body style="background-color:#000000">
  <div class="row">
    <div id="map"></div>

    <div id="navigation" style="text-align:center">
        <h1>Mumbai:<br>Costs of Commuting</h1>
        <h3>Select your home and work to find the cost of your commute.</h3>

        <div class="row">
          <div class="column">
          <h2 id="TextDistance"></h2>
          <h3>Distance</h3>
          </div>

          <div class="column">
          <h2 id="TextOC"></h2>
          <h3>Opportunity Cost</h3>
          </div>
        </div>

        <div class="row">
          <div class="column">
          <h2 id="TextFuelCost"></h2>
          <h3>Economic Cost</h3>
          </div>

          <div class="column">
          <h2 id="TextEnvCost"></h2>
          <h3>Environmental Cost</h3>
          </div>
        </div>
        <br></br>
        <br></br>

        <br></br>
        <br></br>
        <div class="rangeslider">
        <input type="range" min="1" max="100" value="50"
                class="myslider" id="sliderRange">
        <p>Your Monthly Wage (INR): <span id="demo"></span></p>
        </div>
      </div>

        </div>
      </div>




        <!-- <div class="row">
          <div class="b">
            <h3 style="text-align:center">Definitions</h3>
            <h4 style="padding-left:1rem">Distance: Total distance (km).<br>
            Opportunity Cost: Cost of spending additional time commuting, which could have been used for work or leisure (INR). <br>Assumes equal probability of work and leisure and takes as inputs additional commuting hours and a user-supplied monthly wage using this page's slider.<br>
            Total Economic Cost: Opportunity cost plus additional fuel cost for the selected route (INR).<br>
            Total Environmental Cost: Total cost of additional CO<sub>2</sub> emissions for the selected route (INR).<br>
            Note: Generalised exchange rate of USD 1 to INR 70.
            </h4>
          </div>
        </div> -->
        </div>

      </div>
<script>
var rangeslider = document.getElementById("sliderRange");
var output = document.getElementById("demo");
output.innerHTML = rangeslider.value;

rangeslider.oninput = function() {
output.innerHTML = this.value;
}

</script>


<script>
var wage = output;
var dist;
var oc;
var econ;
var env;
var active;

d3.select("#TextDistance").text(" - km");
d3.select("#TextOC").text("- INR");
d3.select("#TextFuelCost").text("- INR");
d3.select("#TextEnvCost").text("- INR");



  var route = L.Routing.control({
      createMarker: function() { return null; },
      waypoints: []
    });

  function DrawARoute(OriginLat, OriginLon, DestLat, DestLon)
  {
    map.removeControl(route);

    var full_url = "https://15.206.6.188:9966/route/v1/driving/"+OriginLat+","+OriginLon+";"+DestLat+","+DestLon+"?overview=false&alternatives=true&steps=true"
    console.log(full_url)

    //https://www.liedman.net/leaflet-routing-machine/tutorials/basic-usage/
    route = L.Routing.control({
      createMarker: function() { return null; },
      waypoints: [
        L.latLng(OriginLat, OriginLon),
        L.latLng(DestLat, DestLon)
      ],

       router: new L.Routing.OSRMv1({
          serviceUrl: 'http://15.206.6.188:5000/route/v1'
        }),
      fitSelectedRoutes: false,
      lineOptions: { styles: [{color: 'black', opacity: 1, weight: 5}]},
      routeWhileDragging: true,
      geometryOnly: true,
      show: false,
      addWaypoints: false
    }).addTo(map);

  }

  var zoomlevel = 12;
  //https://stackoverflow.com/questions/16537326/leafletjs-how-to-remove-the-zoom-control
  var map = L.map('map', { zoomControl: true }).setView([19.0760,72.8777], zoomlevel);
  //map.scrollWheelZoom.disable();
  //map.dragging.disable();

  var tiles_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Map: &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>', minZoom: zoomlevel, maxZoom: 18}).addTo(map);
  // mapLinkCarto = '<a href="https://www.carto.com/basemaps">Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL. </a>';

  // var tiles_carto = L.tileLayer(
  //     'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',{
  //     attribution: '&copy; ' + mapLinkCarto + ' Contributors',minZoom: zoomlevel,maxZoom: zoomlevel,}).addTo(map);
 // "Carto":tiles_carto
  var baseLayers = {"OpenStreetMap": tiles_osm};

  L.control.layers(baseLayers).addTo(map);

</script>

<script>
var a = 0;
var click = a + 1;
var o_id;
var d_id;
var origin_lat;
var origin_lon;
var dest_lat;
var dest_lon;

//https://gist.github.com/d3noob/9211665
var svg = d3.select(map.getPanes().overlayPane).append("svg"),
  g = svg.append("g").attr("class", "leaflet-zoom-hide");

g.attr('pointer-events','all');

//display the CBD and residential points as circles
var places = d3.csv("places.csv");

console.log(places);

Promise.all([places]).then(
  function(values)
  {
    g.selectAll("circle")
      .data(values[0])
      .enter()
      .append("circle")
      .attr("cx", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x })
      .attr("cy", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y })
      .attr("r", "10px")
      .style("fill", function(d){ if(d.Type=="residential") { return "#ea5153"; } else { return "blue"; } })
      .attr("id", function(d, i){ return "circle" + i; });
  }
);

//also display the centroid points which are within the Joined file
d3.json("joined_centroidshexclusters.geojson", function(geoShape) {
//code from http://bl.ocks.org/phil-pedruco/7381401

  let clickEnabled = false;

  //  create a d3.geo.path to convert GeoJSON to SVG
  var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);

  // create path elements for each of the features
  d3_features = g.selectAll("path")
    .data(geoShape.features)
    .enter()
    .append("path");

    map.on("viewreset", reset);
    reset();

  d3_features.on("mouseover", mouseOver)
  .on("mouseout", mouseOut)
  .on("click", onClick)

  // Use Leaflet to implement a D3 geometric transformation.
  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

  // fit the SVG element to leaflet's map layer
  function reset() {

    bounds = path.bounds(geoShape);
    var topLeft = bounds[0],
      bottomRight = bounds[1];
    svg .attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px");

    g .attr("transform", "translate(" + -topLeft[0] + ","
                                     + -topLeft[1] + ")");

    // initialize the path data
    d3_features.attr("d",path)
    .style("fill-opacity",0)
    .attr("fill","#ea5153");

  }

  function mouseOver(d) {
      d3.select(this)
      .transition()
      .style("stroke","#ea5153")
      .style("fill-opacity",1);
      // .style("fill-opacity",0)
      // .style("stroke-opacity",1)
      // .style("stroke-width",5)
      // .style("stroke", "#ea5153");
        }

  function mouseOut(d){
      d3.select(this)
      .transition()
      .style("fill-opacity",0)
      // .style("fill","#F0F0F0")
      .style("stroke-opacity",0);
      // .style('stroke','lightgray');
  }

var highlightedRect = d3.select(null);

  function onClick(d){
    d3.select(this)
    .style("fill-opacity",0.5)
    .style("fill","#ea5153")
    .style("stroke-width",5)
    .style("stroke","black");

    console.log("click number");
    console.log(click);
    console.log("a");
    console.log(a);
    if(click % 3 == 0){
      console.log("i'm divisible by 3");
      // d3.selectAll("g.path")
        // .style("stroke-opacity", 0.5)
        // .style("fill-opacity",0.1)
        // .attr("fill","black")
        // .attr('stroke','lightgray')
    }

    if(a % 2 == 0) {
      origin_lat = d.properties.mumbai_centroids_Lat;
      origin_lon = d.properties.mumbai_centroids_Lon;

      if(a == 0){ //click 1
        o_id = d.properties.MOVEMENT_ID; //get the o_id
        // highlightedRect = d3.select(this)
        // .style("fill-opacity",1)
        // .style("fill","white");
      }
      else if(a != 0){ //a = 2, 4, 6, 8, 10
        o_id = d_id;
        d_id = d.properties.MOVEMENT_ID;
        // highlightedRect = d3.select(this)
        // .style("fill-opacity",1)
        // .style("fill","red");
      }
    }

      else if(a % 2 != 0){ //second click
        dest_lat = d.properties.mumbai_centroids_Lat;
        dest_lon = d.properties.mumbai_centroids_Lon;

        if(d_id == null){
          d_id = d.properties.MOVEMENT_ID;
          // highlightedRect = d3.select(this)
          // .style("fill-opacity",1)
          // .style("fill","white");

        }
        else{ //fourth click
          o_id = d_id;
          d_id = d.properties.MOVEMENT_ID;
          // highlightedRect = d3.select(this)
          // .style("fill-opacity",1)
          // .style("fill","blue");
        }
      }

    a = a + 1; //advance the counter
    click = click + 1; //advance the click

    //make a unique O-D pair variable to filter the CSV data
    o_d_pair = o_id.concat("-",d_id)
    console.log(o_d_pair);

    DrawARoute(origin_lat,origin_lon, dest_lat, dest_lon);
    //read the CSV and get all the values needed for the user
      d3.csv("mumbai_all_tazs.csv", function(data){
        for(var i = 0; i < data.length; i++){
          if(data[i].unique_id == o_d_pair){
            console.log("calculating for TAZs: ");
            console.log(data[i].unique_id);
            //Opportunity cost of congestion = Additional hours in commute *
            //((probability of working * wage cost) + (probability of leisure * (wage cost/2)))
            //9 hour workday, 7 day workweek. what's weekly equation, then convert to hourly
            // wage = 12600;
            dist = data[i].distance;
            oc = data[i].additional_hours_commuting*((0.5*(wage/9/7/4))+(0.5*(wage/9/7/4)));
            econ = data[i].total_economic_costs;
            env = data[i].total_petrol_emissions;

            d3.select("#TextDistance").text(dist + " km");
            d3.select("#TextOC").text(Math.round(oc) +" INR");
            d3.select("#TextFuelCost").text(Math.round(econ) + " INR");
            d3.select("#TextEnvCost").text(Math.round(env) + " INR");

            //make 2 points
            d3.select("#point_src");
            d3.select("#point_dest");
          }
        }
      })

    console.log("done");
    reset();
  }

    });


  //https://www.d3-graph-gallery.com/graph/bubblemap_leaflet_basic.html
  function update()
  {
  //     d3.selectAll("circle")
  //       .attr("cx", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x })
  //       .attr("cy", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y });
  //
  //     d3.selectAll("text")
  //       .attr("x", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x + 15; })
  //       .attr("y", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y + 5; })

  d3.selectAll("polygon")
  .attr("cx", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).x })
  .attr("cy", function(d){ return map.latLngToLayerPoint([d.properties.mumbai_centroids_Lat, d.properties.mumbai_centroids_Lon]).y });

}
  map.on("moveend", update)

</script>

</body></html>
