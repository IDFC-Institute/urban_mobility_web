<!DOCTYPE html>
<head>
  <title>Mumbai: Costs of Commuting</title>
<meta charset="utf-8">
<!-- https://www.d3-graph-gallery.com/graph/backgroundmap_leaflet_buttonLayer.html -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>

<style>
@import url(http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.css);

.navigation {
  float:right;
  background:gray;
  width:25vh;
  height:100vh;
}

#map{
  float:left;
   display:flex;
   flex:75%;
   background:white;
   height:100vh;
  }

#value-vertical{
  float:left:
  display:flex;
  height:100vh;
}
#slider-vertical{
  float:right
  display:flex;
  height:400px;
}

  .container{
    width:100%;
    height:100%;
  }

  .row{
    display:flex;
  }

  .column {
    flex:33%;
    text-align:center;
  }
  .column-50{
    flex:50%;
    text-align:center;
  }

.info {
    width: 200px;
    height:200px;
    padding: 8px 8px;
    background: white;
    background: rgba(255,255,255,1);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 2px;
}

.info h1 {
    margin: 0 0 10px;
    color: #000000;
}

.legend {
  width:200px;
  height:100px;
  line-height: 18px;
  color: #555;
}

.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 8px;
  opacity: 0.7;
}

</style>
</head>


<body>
  <div class="row">
    <div id="map"></div>

    <div id="navigation" style="text-align:center">
        <h1>Traffic Chokepoints in Mumbai</h1>
        <h3>Click a residential area and a CBD to discover traffic-choked segments.</h3>

        <div class="row">
          <h3>AM or PM</h3>
          <p><select name="period" onchange="showHint(this)">
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select></p>

        </div>

        <div class="row">
          <h3>Start Point</h3>

          <p><select name="startpoint" onchange="showHint(this)">
            <option value="Borivali">Borivali</option>
            <option value="Andheri West">Andheri West</option>
            <option value="Chembur">Chembur</option>
            <option value="Marine Drive">Marine Drive</option>
          </select></p>

        </div>

        <div class="row">
          <h3>End Point</h3>
          <p><select name="endpoint" onchange="showHint(this)">
            <option value="Andheri East">Andheri East</option>
            <option value="Lower Parel">Lower Parel</option>
            <option value="Nariman Point">Nariman Point</option>
            <option value="Malad">Malad</option>
          </select></p>
        </div>

        <div class="row">
          <h3>Speeds Key</h3>
        </div>
        </div>
      </div>

<script>

var route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: []
  });

function DrawSpeeds(o_id, d_id)
{
  //draw the geoJSON route on the map
console.log("i'm going to draw the speeds between o_id and d_id");
//concatenate the id's
o_d_pair = o_id.concat("-",d_id);
console.log(o_d_pair);
  //color each segment according to the speed

  d3.json("segments_merged.json", function(geoShape) {

  //  create a d3.geo.path to convert GeoJSON to SVG
  var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);

  // create path elements for each of the features
  d3_features = g.selectAll("path")
    .data(geoShape.features)
    .enter().append("path");

  map.on("viewreset", reset);

  reset();

  // fit the SVG element to leaflet's map layer
  function reset() {

    bounds = path.bounds(geoShape);

    var topLeft = bounds[0],
      bottomRight = bounds[1];

    svg .attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px");

    g .attr("transform", "translate(" + -topLeft[0] + ","
                                      + -topLeft[1] + ")");

    // initialize the path data
    d3_features.attr("d", path)
      .style("fill-opacity", 0)
      //.attr('fill','blue');
      .attr('stroke-width',2)
      .attr('stroke','green');

  }

  // Use Leaflet to implement a D3 geometric transformation.
  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

  });



} //end draw path


function DrawARoute(OriginLat, OriginLon, DestLat, DestLon)
{
  map.removeControl(route);

  var full_url = "http://15.206.6.188:9966/route/v1/driving/"+OriginLat+","+OriginLon+";"+DestLat+","+DestLon+"?overview=false&alternatives=true&steps=true"
  console.log(full_url)

  //https://www.liedman.net/leaflet-routing-machine/tutorials/basic-usage/
  route = L.Routing.control({
    createMarker: function() { return null; },
    waypoints: [
      L.latLng(OriginLat, OriginLon),
      L.latLng(DestLat, DestLon)
    ],

     router: new L.Routing.OSRMv1({
        serviceUrl: 'http://15.206.6.188:5000/route/v1'
      }),

    lineOptions: { styles: [{color: 'navy', opacity: 1, weight: 5}]},
    routeWhileDragging: false,
    geometryOnly: true,
    show: false,
    addWaypoints: false
  }).addTo(map);
}

var map = L
      .map('map', {closePopupOnClick: false})
      .setView([18.9990, 72.8411], 11);

      // var map = L.map('map', { closePopupOnClick: false}).setView([39.7392, -104.9903], 17);

// Tile type: openstreetmap normal
var openstreetmap = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map: &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      minZoom: 10,
      maxZoom: 12
    });

</script>
</body>
</html>

<script>


//https://leafletjs.com/examples/quick-start/
L.svg().addTo(map);

var g = d3.select("#map").select("svg"); // Condenses the SVG selection into g

g.attr('pointer-events', 'all'); //https://stackoverflow.com/a/17495417/7207315

//var places = d3.csv("places.csv");
var places = d3.csv("places.csv");

console.log(places);
var a = 1;
var o_id;
var d_id;
var o_type;
var d_type;


Promise.all([places]).then(
    function(values)
    {

        g.selectAll("circle")
            .data(values[0])
            .enter()
            .append("circle")
            .attr("cx", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x })
            .attr("cy", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y })
            .attr("r", "10px")
            .style("fill", function(d){ if(d.Type=="residential") { return "red"; } else { return "blue"; } })
            .attr("id", function(d, i){ return "circle" + i; })

            // .on("mouseover", function (d, i){ d3.select("#circle" + i).attr("r", "20px"); d3.select("#text" + i).attr("fill", "green");})
            .on("mouseout", function (d, i){
              d3.select("#circle" + i).attr("r", "10px");
              // d3.select("#text" + i).attr("fill", "red");
          })

            .on("click", function (d){

              //allow for two clicks anywhere on the map
              //1 means first click, 0 means second click; pattern alternates between 1 and 0
              if(a == 1){
                origin_lat = d.Lat;
                origin_lon = d.Lon;

                if(o_id == null){
                  o_id = d.Name; //get the o_id
                  o_type = d.Type;
                  console.log("case 1");
                  console.log("type:");
                  console.log(o_type);
                  console.log("origin");
                  console.log(o_id);
                  console.log("dest");
                  console.log(d_id);
                  a = a - 1;

                }
                else {
                  console.log("case 2");
                  o_id = d_id;
                  o_type = d_type;
                  d_id = d.Name;
                  d_type = d.Type;
                  console.log("origin");
                  console.log(o_id);
                  console.log(o_type);
                  console.log("dest");
                  console.log(d_id);
                  console.log(d_type);
                  a = a - 1;
                }
                    }
              else if(a == 0){
                dest_lat = d.Lat;
                dest_lon = d.Lon;
                if(d_id == null){
                  console.log("case 3");
                  d_id = d.Name;
                  d_type = d.Type;
                  console.log("origin");
                  console.log(o_id);
                  console.log(o_type);
                  console.log("dest");
                  console.log(d_id);
                  console.log(d_type);
                  a = a + 1;
                }
                else{
                  console.log("case 4");
                  o_id = d_id;
                  o_type = d_type;
                  d_id = d.Name;
                  d_type = d.Type;
                  console.log("origin");
                  console.log(o_id);
                  console.log(o_type);
                  console.log("dest");
                  console.log(d_id);
                  console.log(d_type);
                  a = a + 1;
                }
              }

              //displays Names for points
              g.selectAll("text")
                  .data(values[0])
                  .enter()
                  .append("text")
                  .text(function(d) { return d.Name; })
                  .attr("font-weight",function(d,i) {return i*100+100;})
                  .attr("font-family","Georgia")
                  .attr("fill", "black")
                  .attr("x", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x + 15; })
                  .attr("y", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y + 5; })
                  .attr("id", function(d, i){ return "text" + i; })

                  .on("mouseover", function (d, i){
                    d3.select("#circle" + i).attr("r", "20px");
                    d3.select("#text" + i).attr("x", function(d){return map.latLngToLayerPoint([d.Lat, d.Lon]).x + 30; })
                    if(d.Type=="residential"){
                      d3.select("#text" + i).attr("fill","red");
                    }
                    else{
                      d3.select("#text" + i).attr("fill","blue");
                    }

                  })
                  .on("mouseout", function (d, i){
                    d3.select("#circle" + i).attr("r", "10px");
                    d3.select("#text" + i).attr("x", function(d){return map.latLngToLayerPoint([d.Lat, d.Lon]).x + 15; })
                    d3.select("#text" + i).attr("fill","black");


                }

              );


            if(o_type != d_type){ //draw the route if different types selected
              DrawARoute(origin_lat,origin_lon, dest_lat, dest_lon);
              DrawSpeeds(o_id, d_id);

            }
            else{ //don't draw the route if they're the same type
              console.log("you selected two of the same type.");
            }
          });

            }
  );

//https://www.d3-graph-gallery.com/graph/bubblemap_leaflet_basic.html
function update()
{
    d3.selectAll("circle")
      .attr("cx", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x })
      .attr("cy", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y });

    d3.selectAll("text")
      .attr("x", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).x + 15; })
      .attr("y", function(d){ return map.latLngToLayerPoint([d.Lat, d.Lon]).y + 5; })
}

map.on("moveend", update)

openstreetmap.addTo(map);


</script>
